const outputEl=document.getElementById("output"),listOutputEl=document.getElementById("listOutput"),urlFileEl=document.getElementById("urlFile"),importUrlsBtn=document.getElementById("importUrls"),extractCurrentBtn=document.getElementById("extractCurrent"),extractBatchBtn=document.getElementById("extractBatch"),pauseBatchBtn=document.getElementById("pauseBatch"),extractListBtn=document.getElementById("extractList"),downloadJsonBtn=document.getElementById("downloadJson"),downloadCsvBtn=document.getElementById("downloadCsv"),downloadUrlsBtn=document.getElementById("downloadUrls"),autoPaginateEl=document.getElementById("autoPaginate"),scheduleTimeEl=document.getElementById("scheduleTime"),saveScheduleBtn=document.getElementById("saveSchedule"),runDailyNowBtn=document.getElementById("runDailyNow"),scheduleInfoEl=document.getElementById("scheduleInfo"),fixedListHintEl=document.getElementById("fixedListHint"),autoCategoryHintEl=document.getElementById("autoCategoryHint"),autoStatusEl=document.getElementById("autoStatus"),verifyBlockEl=document.getElementById("verifyBlock"),verifyBlockTextEl=document.getElementById("verifyBlockText"),verifyResumeBtn=document.getElementById("verifyResume"),cacheUpdateEnabledEl=document.getElementById("cacheUpdateEnabled"),downloadHistoryCsvBtn=document.getElementById("downloadHistoryCsv"),viewCacheBtn=document.getElementById("viewCache"),downloadCacheBtn=document.getElementById("downloadCache"),runFilterBtn=document.getElementById("runFilter"),downloadFilterBtn=document.getElementById("downloadFilter"),filterOutputEl=document.getElementById("filterOutput"),downloadHistoryBtn=document.getElementById("downloadHistory"),tabButtons=Array.from(document.querySelectorAll(".tab-button")),tabPanels=Array.from(document.querySelectorAll(".tab-panel")),filterLast30QtyEl=document.getElementById("filterLast30Qty"),filterDiscountedPriceEl=document.getElementById("filterDiscountedPrice"),filterListedDateEl=document.getElementById("filterListedDate"),filterSkuDropEl=document.getElementById("filterSkuDrop"),filterSkuAvgDropEl=document.getElementById("filterSkuAvgDrop"),filterSkuAvgWindowEl=document.getElementById("filterSkuAvgWindow");let results=[],listUrls=[],importedUrls=[];const MAX_LIST_PAGES=50,FIXED_BATCH_CONCURRENCY=1,FIXED_LIST_URL="https://shopee.ph/Motorcycle-ATV-Parts-cat.11020952.11020975?page=0",FIXED_LIST_URL_PATTERN="*://shopee.ph/Motorcycle-ATV-Parts-cat.11020952.11020975*",AUTO_CATEGORY_URL=FIXED_LIST_URL,TAB_STORAGE_KEY="popupActiveTab",TAB_READY_TIMEOUT_MS=6e4;let batchPaused=!1,batchRunning=!1,filterUrls=[];const STORAGE_KEYS={importedUrls:"importedUrls",listUrls:"listUrls",listMeta:"listMeta",batchResults:"batchResults",scheduleTime:"scheduleTime",dailySnapshots:"dailySnapshots",lastRunAt:"lastRunAt",nextRunAt:"nextRunAt",cacheUpdateEnabled:"cacheUpdateEnabled",cachedCategoryUrl:"cachedCategoryUrl",cachedCategoryUrls:"cachedCategoryUrls",cachedCategoryUpdatedAt:"cachedCategoryUpdatedAt"};function storageGet(t){return new Promise(e=>{chrome.storage.local.get(t,t=>e(t||{}))})}function storageSet(t){return new Promise(e=>{chrome.storage.local.set(t,()=>e())})}function setActiveTab(t){tabButtons.forEach(e=>{const n=e.dataset.tab===t;e.classList.toggle("is-active",n)}),tabPanels.forEach(e=>{const n=e.dataset.tab===t;e.classList.toggle("is-active",n)}),t&&localStorage.setItem(TAB_STORAGE_KEY,t)}function restoreActiveTab(){const t=localStorage.getItem(TAB_STORAGE_KEY),e=tabButtons.map(t=>t.dataset.tab).filter(Boolean),n=e.length?e[0]:null,r=e.includes(t)?t:n;r&&setActiveTab(r)}function tabsQuery(t){return new Promise(e=>{chrome.tabs.query(t,t=>e(t||[]))})}function tabsCreate(t){return new Promise(e=>{chrome.tabs.create(t,t=>e(t))})}function tabsUpdate(t,e){return new Promise(n=>{chrome.tabs.update(t,e,t=>n(t))})}async function bindSessionContext(){const[t]=await tabsQuery({active:!0,currentWindow:!0});t&&chrome.runtime.sendMessage({type:"session-bind",windowId:t.windowId,incognito:t.incognito})}function waitForTabComplete(t,e){return new Promise((n,r)=>{const s=setTimeout(()=>{chrome.tabs.onUpdated.removeListener(a),r(new Error("页面加载超时"))},6e4);function a(r,o,l){r===t&&"complete"===o.status&&(e&&l?.url&&!l.url.startsWith(e)||(clearTimeout(s),chrome.tabs.onUpdated.removeListener(a),n(l)))}chrome.tabs.onUpdated.addListener(a)})}async function ensureFixedListTab(){let t=(await tabsQuery({url:FIXED_LIST_URL_PATTERN})).find(t=>t&&t.id&&!t.incognito);return t&&t.id?t.url!==FIXED_LIST_URL?t=await tabsUpdate(t.id,{url:FIXED_LIST_URL,active:!0}):await tabsUpdate(t.id,{active:!0}):t=await tabsCreate({url:FIXED_LIST_URL,active:!0}),t&&t.id?t.incognito?null:"complete"===t.status&&t.url&&t.url.startsWith(FIXED_LIST_URL)?t:waitForTabComplete(t.id,FIXED_LIST_URL):null}function toYmd(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function parseYmd(t){if(!t||!/^\d{4}-\d{2}-\d{2}$/.test(t))return null;const[e,n,r]=t.split("-").map(t=>Number.parseInt(t,10));return e&&n&&r?new Date(e,n-1,r):null}function daysBetween(t,e){return Math.round((e-t)/864e5)}function setOutput(t){outputEl.textContent=t}function setListOutput(t){listOutputEl.textContent=t}function updateDownloadButtons(){const t=results.length>0;downloadJsonBtn.disabled=!t,downloadCsvBtn.disabled=!t}function updatePauseButton(){const t=batchRunning||batchPaused;pauseBatchBtn.disabled=!t,pauseBatchBtn.textContent=batchPaused?"继续":"暂停"}function updateUrlDownloadButton(){downloadUrlsBtn.disabled=0===listUrls.length}function persistImportedUrls(){return storageSet({[STORAGE_KEYS.importedUrls]:importedUrls})}function persistResults(){return storageSet({[STORAGE_KEYS.batchResults]:results})}function persistListState(t){return storageSet({[STORAGE_KEYS.listUrls]:listUrls,[STORAGE_KEYS.listMeta]:t||null})}function updateScheduleInfo({lastRunAt:t,nextRunAt:e}){const n=[];t&&n.push(`上次: ${new Date(t).toLocaleString()}`),e&&n.push(`下次: ${new Date(e).toLocaleString()}`),scheduleInfoEl.textContent=n.length?n.join(" | "):"尚未设置自动抓取"}function setFilterOutput(t){filterOutputEl.textContent=t}function setAutoStatus(t){autoStatusEl&&(autoStatusEl.textContent=t)}function showVerifyBlock({url:t,until:e}={}){if(!verifyBlockEl)return;verifyBlockEl.classList.remove("is-hidden");const n=[];if(t&&n.push(`URL: ${t}`),e){const t=new Date(e).toLocaleString();n.push(`自动解锁: ${t}`)}verifyBlockTextEl&&(verifyBlockTextEl.textContent=n.join(" | ")||"触发验证页，请手动完成验证后继续")}function hideVerifyBlock(){verifyBlockEl&&(verifyBlockEl.classList.add("is-hidden"),verifyBlockTextEl&&(verifyBlockTextEl.textContent=""))}function updateFilterDownloadButton(){downloadFilterBtn.disabled=0===filterUrls.length}function getRecordDateText(t){if(t?.date)return t.date;const e=t?.capturedAt||t?.extractedAt||"";return e?e.slice(0,10):null}function getRecordSkuList(t){return Array.isArray(t?.skus)?t.skus:Array.isArray(t?.sku)?t.sku:[]}function getRecordLast30Qty(t){return"number"==typeof t?.last30Qty?t.last30Qty:"number"==typeof t?.sales?.last30Qty?t.sales.last30Qty:null}function getRecordOriginalPrice(t){return"number"==typeof t?.originalPrice?t.originalPrice:Array.isArray(t?.originalPrice)&&t.originalPrice.length?Math.max(...t.originalPrice.filter(t=>"number"==typeof t)):"number"==typeof t?.price?.original?t.price.original:Array.isArray(t?.price?.originalRange)&&t.price.originalRange.length?Math.max(...t.price.originalRange.filter(t=>"number"==typeof t)):null}function getRecordProductId(t){return t?.productId?t.productId:t?.data?.productId?t.data.productId:""}function getRecordDiscountedPriceMax(t){const e=Array.isArray(t?.price?.currentPHPRange)?t.price.currentPHPRange:null;if(e&&e.length){const t=e.filter(t=>"number"==typeof t);return t.length?Math.max(...t):null}return"number"==typeof t?.price?.currentPHP?t.price.currentPHP:null}function getRecordOriginalRange(t){return Array.isArray(t?.originalPrice)&&t.originalPrice.length?t.originalPrice.filter(t=>"number"==typeof t):Array.isArray(t?.price?.originalRange)&&t.price.originalRange.length?t.price.originalRange.filter(t=>"number"==typeof t):"number"==typeof t?.originalPrice?[t.originalPrice]:"number"==typeof t?.price?.original?[t.price.original]:[]}function getFilterOptions(){const t=Boolean(filterLast30QtyEl?.checked),e=Boolean(filterDiscountedPriceEl?.checked),n=Boolean(filterListedDateEl?.checked),r=Boolean(filterSkuDropEl?.checked),s=Boolean(filterSkuAvgDropEl?.checked),a=Number.parseInt(filterSkuAvgWindowEl?.value||"7",10),o=Number.isNaN(a)?7:Math.min(60,Math.max(3,a));filterSkuAvgWindowEl&&(filterSkuAvgWindowEl.value=String(o));return{requireLast30Qty:t,requireDiscountedPrice:e,requireListedDate:n,requireSkuDrop:r,requireSkuAvgDrop:s,skuAvgWindow:o,skuAvgThreshold:10,anySelected:t||e||n||r||s}}function hasSkuDrop(t){const e=new Map;for(const n of t){const t=getRecordDateText(n);if(!n||!t)continue;const r=getRecordSkuList(n);if(r.length)for(const n of r){const r=n?.name||"",s=n?.stock;r&&"number"==typeof s&&(e.has(r)||e.set(r,new Map),e.get(r).set(t,s))}}for(const[t,n]of e.entries()){const t=Array.from(n.keys()).sort();let e=1,r=null,s=null;for(const a of t){const t=n.get(a),o=parseYmd(a);if(o){if(r){1===daysBetween(r,o)&&s-t>=10?e+=1:e=1}if(e>=5)return!0;r=o,s=t}else e=1,r=null,s=null}}return!1}function hasSkuAverageDrop(t,e,n){const r=new Map;for(const e of t){const t=getRecordDateText(e),n=t?parseYmd(t):null;if(!n)continue;const s=getRecordSkuList(e);if(s.length)for(const e of s){const s=e?.name||"",a=e?.stock;s&&"number"==typeof a&&(r.has(s)||r.set(s,new Map),r.get(s).set(t,{date:n,stock:a}))}}for(const t of r.values()){const r=Array.from(t.values()).sort((t,e)=>t.date-e.date);if(r.length<e)continue;const s=r.slice(-e),a=s[0],o=s[s.length-1],l=daysBetween(a.date,o.date);if(l<=0)continue;const i=a.stock-o.stock;if(i<=0)continue;if(i/l>=n)return!0}return!1}function matchesRules(t,e){if(!t.length)return!1;const n=t.slice().sort((t,e)=>(getRecordDateText(t)||"").localeCompare(getRecordDateText(e)||"")),r=n[n.length-1];if(!r)return!1;if(!e?.anySelected)return!0;if(e?.requireLast30Qty){const t=getRecordLast30Qty(r);if(null==t||t<=200)return!1}if(e?.requireDiscountedPrice){const t=getRecordDiscountedPriceMax(r);if(null==t||t<=150)return!1}if(e?.requireListedDate){const t=parseYmd(r.listedDate);if(!t)return!1;if(daysBetween(t,new Date)>500)return!1}return!(e?.requireSkuDrop&&!hasSkuDrop(n))&&!(e?.requireSkuAvgDrop&&!hasSkuAverageDrop(n,e.skuAvgWindow,e.skuAvgThreshold))}function appendResult(t){results.push(t),setOutput(JSON.stringify(results,null,2)),updateDownloadButtons(),persistResults()}function formatJsonl(t){return t.map(t=>JSON.stringify(t)).join("\n")}function formatCsv(t){const e=["url","productId","sellerName","category","currentPricePHPRange","currentPriceCNYRange","originalPriceRange","discount","listedDate","totalQty","last30Qty","totalRevenue","last30Revenue","skuName","skuPrice","skuStock","skuSalesShare","skuSalesEstimate","error"],n=[e.join(",")];for(const r of t){if(!r||!r.result||!r.result.success){const t=new Array(e.length).fill("");t[0]=r?.url||"",t[e.length-1]=r?.result?.error||"",n.push(t.map(csvEscape).join(","));continue}const t=r.result.data,s=t.sku&&t.sku.length?t.sku:[null];for(const e of s)n.push([t.url||"",t.productId||"",t.sellerName||"",t.category||"",t.price?.currentPHPRange?JSON.stringify(t.price.currentPHPRange):"",t.price?.currentCNYRange?JSON.stringify(t.price.currentCNYRange):"",t.price?.originalRange?JSON.stringify(t.price.originalRange):"",t.price?.discount??"",t.listedDate||"",t.sales?.totalQty??"",t.sales?.last30Qty??"",t.sales?.totalRevenue??"",t.sales?.last30Revenue??"",e?.name||"",e?.price??"",e?.stock??"",e?.salesShare||"",e?.salesEstimate??"",""].map(csvEscape).join(","))}return n.join("\n")}function formatSnapshotCsv(t){const e=[["date","capturedAt","url","productId","listedDate","originalPriceRange","last30Qty","skus"].join(",")];for(const n of t){const t=getRecordSkuList(n),r=n?.capturedAt||n?.extractedAt||"";e.push([getRecordDateText(n)||"",r,n?.url||"",n?.productId??"",n?.listedDate??"",(()=>{const t=getRecordOriginalRange(n);return t.length?JSON.stringify(t):""})(),getRecordLast30Qty(n)??"",t.length?JSON.stringify(t):""].map(csvEscape).join(","))}return e.join("\n")}function csvEscape(t){const e=String(t??"");return/[,"\n]/.test(e)?`"${e.replace(/"/g,'""')}"`:e}function downloadFile(t,e,n){const r=new Blob([t],{type:n}),s=URL.createObjectURL(r);chrome.downloads.download({url:s,filename:e,saveAs:!0},()=>{URL.revokeObjectURL(s)})}async function restoreState(){const t=await storageGet([STORAGE_KEYS.importedUrls,STORAGE_KEYS.listUrls,STORAGE_KEYS.listMeta,STORAGE_KEYS.batchResults,STORAGE_KEYS.scheduleTime,STORAGE_KEYS.cacheUpdateEnabled,STORAGE_KEYS.lastRunAt,STORAGE_KEYS.nextRunAt]);importedUrls=Array.isArray(t[STORAGE_KEYS.importedUrls])?t[STORAGE_KEYS.importedUrls]:[],listUrls=Array.isArray(t[STORAGE_KEYS.listUrls])?t[STORAGE_KEYS.listUrls]:[],results=Array.isArray(t[STORAGE_KEYS.batchResults])?t[STORAGE_KEYS.batchResults]:[];const e=t[STORAGE_KEYS.scheduleTime];if(e&&(scheduleTimeEl.value=e),cacheUpdateEnabledEl){const e=t[STORAGE_KEYS.cacheUpdateEnabled];cacheUpdateEnabledEl.checked=!1!==e}if(updateScheduleInfo({lastRunAt:t[STORAGE_KEYS.lastRunAt]||null,nextRunAt:t[STORAGE_KEYS.nextRunAt]||null}),updateDownloadButtons(),updateUrlDownloadButton(),updatePauseButton(),results.length?setOutput(JSON.stringify(results,null,2)):importedUrls.length&&setOutput(`已导入 ${importedUrls.length} 条URL`),listUrls.length){const e=t[STORAGE_KEYS.listMeta]||{},n=[`共 ${listUrls.length} 条链接`,`页数: ${e.pages||0}`];e.warnings&&e.warnings.length&&n.push(`提示: ${e.warnings.join("；")}`),n.push(""),n.push(...listUrls),setListOutput(n.join("\n"))}chrome.runtime.sendMessage({type:"batch-status"},t=>{t&&(batchPaused=Boolean(t.paused),batchRunning=Boolean(t.running),updatePauseButton())}),chrome.runtime.sendMessage({type:"config-status"},t=>{t&&(t.scheduleTime&&(scheduleTimeEl.value=t.scheduleTime),cacheUpdateEnabledEl&&"boolean"==typeof t.cacheUpdateEnabled&&(cacheUpdateEnabledEl.checked=t.cacheUpdateEnabled),updateScheduleInfo({lastRunAt:t.lastRunAt,nextRunAt:t.nextRunAt}),t.verifyBlocked?showVerifyBlock({url:t.verifyBlockedUrl,until:t.verifyBlockedUntil}):hideVerifyBlock())})}extractCurrentBtn.addEventListener("click",async()=>{setOutput("提取中..."),results=[],updateDownloadButtons();const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t&&t.id?t.incognito?setOutput("当前为无痕窗口，无法共享登录态"):chrome.tabs.sendMessage(t.id,{type:"extract"},e=>{const n=chrome.runtime.lastError;n?setOutput(`提取失败: ${n.message}`):appendResult({url:t.url,result:e})}):setOutput("未找到当前标签页")}),extractBatchBtn.addEventListener("click",async()=>{const t=importedUrls.filter(Boolean);if(!t.length)return void setOutput("请先导入URL文件");results=[],updateDownloadButtons(),setOutput("批量提取中..."),persistResults();const[e]=await tabsQuery({active:!0,currentWindow:!0});chrome.runtime.sendMessage({type:"batch-start",urls:t,concurrency:1,windowId:e?.windowId,incognito:e?.incognito},t=>{if(!t||!t.started)return setOutput(`批量启动失败: ${t?.error||"未知错误"}`),batchRunning=!1,void updatePauseButton();batchRunning=!0,batchPaused=!1,updatePauseButton()})}),pauseBatchBtn.addEventListener("click",()=>{const t=batchPaused?"batch-resume":"batch-pause";chrome.runtime.sendMessage({type:t},t=>{t&&(batchPaused=Boolean(t.paused),batchRunning=!0,updatePauseButton())})}),importUrlsBtn.addEventListener("click",()=>{if(!urlFileEl.files||!urlFileEl.files.length)return void setOutput("请先选择要导入的文件");const t=urlFileEl.files[0],e=new FileReader;e.onload=()=>{const n="string"==typeof e.result?e.result:"";importedUrls=n.split(/\n+/).map(t=>t.trim()).filter(Boolean),setOutput(`已导入 ${t.name}，共 ${importedUrls.length} 条`),persistImportedUrls(),updatePauseButton()},e.onerror=()=>{setOutput("文件读取失败")},e.readAsText(t)}),saveScheduleBtn.addEventListener("click",async()=>{const t=scheduleTimeEl.value||"02:00",e=AUTO_CATEGORY_URL,n=!cacheUpdateEnabledEl||Boolean(cacheUpdateEnabledEl.checked),[r]=await tabsQuery({active:!0,currentWindow:!0});storageSet({[STORAGE_KEYS.scheduleTime]:t,categoryUrl:e,[STORAGE_KEYS.cacheUpdateEnabled]:n}).then(()=>{chrome.runtime.sendMessage({type:"config-update",scheduleTime:t,categoryUrl:e,cacheUpdateEnabled:n,windowId:r?.windowId,incognito:r?.incognito},t=>{t&&t.ok?(setAutoStatus("自动抓取配置已保存"),chrome.runtime.sendMessage({type:"config-status"},t=>{t&&updateScheduleInfo({lastRunAt:t.lastRunAt,nextRunAt:t.nextRunAt})})):setAutoStatus("自动抓取配置保存失败")})})}),runDailyNowBtn.addEventListener("click",async()=>{const t=scheduleTimeEl.value||"02:00",e=!cacheUpdateEnabledEl||Boolean(cacheUpdateEnabledEl.checked),[n]=await tabsQuery({active:!0,currentWindow:!0});chrome.runtime.sendMessage({type:"config-update",scheduleTime:t,categoryUrl:AUTO_CATEGORY_URL,cacheUpdateEnabled:e,windowId:n?.windowId,incognito:n?.incognito},()=>{chrome.runtime.sendMessage({type:"daily-run-now",windowId:n?.windowId,incognito:n?.incognito},()=>{setAutoStatus("已触发自动抓取任务")})})}),verifyResumeBtn&&verifyResumeBtn.addEventListener("click",()=>{chrome.runtime.sendMessage({type:"verify-resume"},()=>{setAutoStatus("已恢复抓取"),hideVerifyBlock()})}),runFilterBtn.addEventListener("click",async()=>{setFilterOutput("筛选中..."),filterUrls=[],updateFilterDownloadButton();const t=getFilterOptions(),e=await storageGet([STORAGE_KEYS.dailySnapshots]),n=Array.isArray(e[STORAGE_KEYS.dailySnapshots])?e[STORAGE_KEYS.dailySnapshots]:[];if(!n.length)return void setFilterOutput("暂无历史数据");const r=new Map;for(const t of n)t&&t.url&&(r.has(t.url)||r.set(t.url,[]),r.get(t.url).push(t));for(const[e,n]of r.entries())if(matchesRules(n,t)){const t=n.slice().sort((t,e)=>(getRecordDateText(t)||"").localeCompare(getRecordDateText(e)||"")),r=getRecordProductId(t[t.length-1]);filterUrls.push({url:e,productId:r})}updateFilterDownloadButton();const s=[`符合条件 ${filterUrls.length} 条`];s.push(""),s.push(...filterUrls.map(t=>`${t.productId||""}\t${t.url}`)),setFilterOutput(s.join("\n"))}),downloadFilterBtn.addEventListener("click",()=>{downloadFile(filterUrls.map(t=>`${t.productId||""}\t${t.url}`).join("\n"),`shopee_filter_${Date.now()}.txt`,"text/plain")}),downloadHistoryBtn.addEventListener("click",async()=>{const t=await storageGet([STORAGE_KEYS.dailySnapshots]),e=Array.isArray(t[STORAGE_KEYS.dailySnapshots])?t[STORAGE_KEYS.dailySnapshots]:[];if(!e.length)return void setAutoStatus("暂无历史数据可下载");downloadFile(e.map(t=>JSON.stringify(t)).join("\n"),`shopee_history_${Date.now()}.jsonl`,"text/plain")}),downloadHistoryCsvBtn&&downloadHistoryCsvBtn.addEventListener("click",async()=>{const t=await storageGet([STORAGE_KEYS.dailySnapshots]),e=Array.isArray(t[STORAGE_KEYS.dailySnapshots])?t[STORAGE_KEYS.dailySnapshots]:[];if(!e.length)return void setAutoStatus("暂无历史数据可下载");downloadFile(formatSnapshotCsv(e),`shopee_history_${Date.now()}.csv`,"text/csv")}),viewCacheBtn&&viewCacheBtn.addEventListener("click",async()=>{const t=await storageGet([STORAGE_KEYS.cachedCategoryUrl,STORAGE_KEYS.cachedCategoryUrls,STORAGE_KEYS.cachedCategoryUpdatedAt,STORAGE_KEYS.listUrls]),e=Array.isArray(t[STORAGE_KEYS.cachedCategoryUrls])?t[STORAGE_KEYS.cachedCategoryUrls]:[],n=Array.isArray(t[STORAGE_KEYS.listUrls])?t[STORAGE_KEYS.listUrls]:[],r=e.length?e:n;if(!r.length)return void setAutoStatus("暂无缓存URL");const s=t[STORAGE_KEYS.cachedCategoryUpdatedAt]||"";setFilterOutput([`缓存URL: ${t[STORAGE_KEYS.cachedCategoryUrl]||"未记录"}`,s?`更新时间: ${s}`:"更新时间: 未记录",`数量: ${r.length}`,"",...r].join("\n")),setActiveTab("auto")}),downloadCacheBtn&&downloadCacheBtn.addEventListener("click",async()=>{const t=await storageGet([STORAGE_KEYS.cachedCategoryUrls,STORAGE_KEYS.listUrls]),e=Array.isArray(t[STORAGE_KEYS.cachedCategoryUrls])?t[STORAGE_KEYS.cachedCategoryUrls]:[],n=Array.isArray(t[STORAGE_KEYS.listUrls])?t[STORAGE_KEYS.listUrls]:[],r=e.length?e:n;r.length?downloadFile(r.join("\n"),`shopee_cache_${Date.now()}.txt`,"text/plain"):setAutoStatus("暂无缓存URL可下载")}),extractListBtn.addEventListener("click",async()=>{let t;setListOutput("打开固定分类页..."),listUrls=[],updateUrlDownloadButton(),persistListState(null);try{t=await ensureFixedListTab()}catch(t){return void setListOutput(`打开固定分类页失败: ${t.message}`)}t&&t.id?t.incognito?setListOutput("当前为无痕窗口，无法共享登录态"):(setListOutput("页面加载完成，开始抓取..."),chrome.tabs.sendMessage(t.id,{type:"collect-product-urls",paginate:autoPaginateEl.checked,maxPages:50},t=>{const e=chrome.runtime.lastError;if(e)return void setListOutput(`抓取失败: ${e.message}`);if(!t||!t.success)return void setListOutput(`抓取失败: ${t?.error||"未知错误"}`);listUrls=t.urls||[],updateUrlDownloadButton();const n=[`共 ${listUrls.length} 条链接`,`页数: ${t.pages||0}`];t.warnings&&t.warnings.length&&n.push(`提示: ${t.warnings.join("；")}`),persistListState({pages:t.pages||0,warnings:t.warnings||[]}),n.push(""),n.push(...listUrls),setListOutput(n.join("\n"))})):setListOutput("未能打开固定分类页（请使用非无痕窗口）")}),chrome.runtime.onMessage.addListener(t=>{t&&("batch-progress"===t.type&&(batchRunning=!0,appendResult({url:t.payload.url,result:t.payload.result}),updatePauseButton()),"batch-complete"===t.type&&(Array.isArray(t.results)&&t.results.length&&(results=t.results),setOutput(JSON.stringify(results,null,2)),batchRunning=!1,batchPaused=!1,updatePauseButton(),persistResults()),"verify-blocked"===t.type&&(showVerifyBlock({url:t.url,until:t.until}),setAutoStatus("触发验证页，已暂停抓取")),"verify-clear"===t.type&&(hideVerifyBlock(),setAutoStatus("验证已清除，抓取已继续")))}),downloadJsonBtn.addEventListener("click",()=>{downloadFile(formatJsonl(results),`shopdora_${Date.now()}.jsonl`,"text/plain")}),downloadCsvBtn.addEventListener("click",()=>{downloadFile(formatCsv(results),`shopdora_${Date.now()}.csv`,"text/csv")}),downloadUrlsBtn.addEventListener("click",()=>{downloadFile(listUrls.join("\n"),`shopee_urls_${Date.now()}.txt`,"text/plain")}),setOutput("等待提取..."),setListOutput("等待抓取..."),setFilterOutput("等待筛选..."),updateUrlDownloadButton(),updatePauseButton(),updateFilterDownloadButton(),bindSessionContext(),tabButtons.length&&(tabButtons.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.tab;e&&setActiveTab(e)})}),restoreActiveTab()),restoreState();