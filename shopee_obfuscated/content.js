(()=>{const t=3e4,e=1e3,n=3e3;function r(t){return new Promise(e=>setTimeout(e,t))}function o(t){const e=function(t){if(!t||"transparent"===t)return null;const e=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/i);return e?{r:Number(e[1]),g:Number(e[2]),b:Number(e[3]),a:null==e[4]?1:Number(e[4])}:null}(t);if(!e||0===e.a)return!1;const{h:n,s:r,l:o}=function({r:t,g:e,b:n}){const r=t/255,o=e/255,s=n/255,a=Math.max(r,o,s),i=Math.min(r,o,s);let l=0,c=0;const u=(a+i)/2;if(a!==i){const t=a-i;switch(c=u>.5?t/(2-a-i):t/(a+i),a){case r:l=(o-s)/t+(o<s?6:0);break;case o:l=(s-r)/t+2;break;default:l=(r-o)/t+4}l*=60}return{h:l,s:100*c,l:100*u}}(e);return n>=15&&n<=50&&r>=35&&o>=20&&o<=85}function s(t){if(!(t instanceof HTMLElement))return!1;const e=(t.innerText||t.textContent||"").trim();if(e&&/shopdora/i.test(e))return!0;const n=t.getAttributeNames();for(const e of n){const n=t.getAttribute(e);if(e&&/shopdora/i.test(e)||n&&/shopdora/i.test(n))return!0}return!1}function a(){const t=document.querySelector("#shopdora-detailPage, #shopdora-shopee-product-detail");if(t)return t;const e=[];let n=0;for(const t of function*(t){if(!t)return;const e=[t];for(;e.length;){const t=e.pop();if(!t)continue;yield t;const n=t.children?Array.from(t.children):[];for(let t=n.length-1;t>=0;t-=1)e.push(n[t]);t.shadowRoot&&e.push(t.shadowRoot)}}(document.body)){if(n+=1,n>8e3)break;t instanceof HTMLElement&&(s(t)&&e.push(t))}const r=Array.from(document.querySelectorAll('[class*="shopdora" i], [id*="shopdora" i]'));for(const t of r)e.includes(t)||e.push(t);if(!e.length)return null;let a=null,i=0;for(const t of e){let e=t;for(let t=0;t<6&&e;t+=1){const t=e.getBoundingClientRect(),n=Math.max(0,t.width)*Math.max(0,t.height)+(o(getComputedStyle(e).backgroundColor)?1e4:0)+((e.innerText||"").length||0);n>i&&(i=n,a=e),e=e.parentElement}}return a}function i(t){if(!t)return null;const e=t.replace(/[,\s]/g,""),n=Number(e);return Number.isNaN(n)?null:n}function l(t,e){for(const n of e){const e=t.match(n);if(e)return e}return null}function c(t,e){const n=new RegExp(`${e}\\s*([\\d,.]+)`),r=t.match(n);return r?i(r[1]):null}function u(t,e){const n=Math.min(t,e),r=Math.max(t,e);return Math.floor(n+Math.random()*(r-n+1))}async function f(t,e){await r(u(t,e))}function h(t){if(!(t instanceof HTMLElement))return!1;const e=t.getBoundingClientRect();if(e.width<6||e.height<6)return!1;if(e.bottom<0||e.top>window.innerHeight)return!1;const n=getComputedStyle(t);return"none"!==n.display&&"hidden"!==n.visibility&&"none"!==n.pointerEvents}async function d(t){if(!h(t))return;t.scrollIntoView({block:"center",behavior:"smooth"}),await f(500,2e3);t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation()},{capture:!0,once:!0}),t.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window})),t.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window})),t.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))}function m(){const t=['input[type="search"]','input[type="text"]',"textarea",'[role="searchbox"]',".shopee-searchbar input",'a[href*="cat."]',".shopee-category-list a",'[data-sqe*="category"]','[data-sqe*="recommend"]','[data-sqe*="item"]'],e=new Set;for(const n of t)document.querySelectorAll(n).forEach(t=>e.add(t));return Array.from(e).filter(t=>h(t)&&!function(t){return t instanceof HTMLElement&&!!t.closest('[id*="shopdora" i], [class*="shopdora" i]')}(t))}function g(t,e){if(!t)return null;const n=new RegExp(`${e}\\s*([\\d,.]+)\\s*(?:-|~|～|—|–|至|to)\\s*${e}?\\s*([\\d,.]+)`,"i"),r=t.match(n);if(!r)return null;const o=i(r[1]),s=i(r[2]);return null==o||null==s?null:o<=s?{min:o,max:s}:{min:s,max:o}}function p(t,e){for(const n of t)for(const t of e){const e=n.match(t);if(e)return(e[1]||e[2]||"").trim()}return null}function w(t,e){const n=Array.from(t.querySelectorAll(".detail-info-item"));for(const t of n){const n=t.querySelector(".detail-info-item-title"),r=t.querySelector(".detail-info-item-main .item-main");if(!n||!r)continue;const o=(n.innerText||"").trim();if(e.test(o))return(r.innerText||"").trim()}return null}function y(t){const e={currentPHPRange:null,currentCNYRange:null,originalRange:null,discount:null},n=t.querySelector(".shopdoraPirceList")||document.querySelector(".shopdoraPirceList");if(n){const t=c(n.textContent||"","¥");null!=t&&(e.currentCNYRange=[t])}let r="";const o=t.querySelector(".flex.flex-column.IFdRIb")||document.querySelector(".flex.flex-column.IFdRIb")||(n?n.closest("section")||n.parentElement:null);o&&(r=o.textContent||"");const s=t.querySelector(".jRlVo0")||document.querySelector(".jRlVo0");if(s){const t=s.querySelector(".IZPeQz"),n=s.querySelector(".ZA5sW5"),o=s.querySelector(".vms4_3");if(t){const n=t.textContent||"",r=g(n,"₱");if(r)e.currentPHPRange=[r.min,r.max];else{const t=c(n,"₱");null!=t&&(e.currentPHPRange=[t])}}if(n){const t=n.textContent||"",r=g(t,"₱");if(r)e.originalRange=[r.min,r.max];else{const n=c(t,"₱");null!=n&&(e.originalRange=[n])}}if(o){const t=(o.textContent||"").match(/-?\d+(?:\.\d+)?%/);e.discount=t?t[0]:e.discount}r||(r=s.textContent||"")}if(!r){const e=n?.closest("#shopdora-detailPage")||t,o=Array.from(e.querySelectorAll("section, div")).filter(t=>{const e=(t.textContent||"").trim();return e.includes("₱")&&e.includes("%")});o.length&&(r=o.sort((t,e)=>t.textContent.length-e.textContent.length)[0].textContent||"")}if(r){const t=r,n=g(t,"₱");n&&(e.currentPHPRange=[n.min,n.max]);const o=g(t,"¥");o&&(e.currentCNYRange=[o.min,o.max]);const s=function(t,e){if(!t)return[];const n=new RegExp(`${e}\\s*([\\d,.]+)`,"g"),r=[];let o;for(;null!==(o=n.exec(t));){const t=i(o[1]);null!=t&&r.push(t)}return r}(t,"₱");s.length&&(e.currentPHPRange||(e.currentPHPRange=[s[0]??null].filter(t=>null!=t)),e.originalRange||(n&&s.length>=4?e.originalRange=[s[2],s[3]].filter(t=>null!=t):!n&&s.length>=2&&(e.originalRange=[s[1]].filter(t=>null!=t))));const a=t.match(/-?\\d+(?:\\.\\d+)?%/);a&&(e.discount=a[0])}return e}function b(t){const e=[],n=t.innerText||t.textContent||"",{lines:r}=function(t){const e=t.split(/\n+/).map(t=>t.trim()).filter(Boolean),n=new Map;for(const t of e)if(t.includes(":")||t.includes("：")){const e=t.split(/[:：]/);if(e.length>=2){const t=e[0].trim(),r=e.slice(1).join(":").trim();t&&r&&n.set(t,r)}}return{lines:e,map:n}}(n),o=location.href,s=o.match(/i\.(\d+)\.(\d+)/),a=w(t,/商品id|商品ID|Product ID/i),c=a?a.match(/\d+/):null,u=s?s[2]:c?c[0]:null,f=w(t,/卖家|Seller/i)||p(r,[/卖家\s*[:：]\s*(.+)/i,/Seller\s*[:：]\s*(.+)/i]),h=w(t,/类目|Category/i)||p(r,[/类目\s*[:：]\s*(.+)/i,/Category\s*[:：]\s*(.+)/i]),d=w(t,/上架时间|Listing Date|Listed on/i)||p(r,[/上架时间\s*[:：]\s*(.+)/i,/Listing Date\s*[:：]\s*(.+)/i]),m=d?d.match(/(\d{4}-\d{2}-\d{2})/):null,g=m?m[1]:null,b=y(t);let S=b.currentPHPRange,x=b.currentCNYRange;const R=b.originalRange,A=b.discount,k=(w(t,/总销量|Total Sold|Total Sales/i)||"").match(/([\d,.]+)/)||l(n,[/(?:总销量|Total Sales|Total Sold)\s*[:：]?\s*([\d,.]+)/i]),E=(w(t,/近30日销量|30天销量|Last 30 days/i)||"").match(/([\d,.]+)/)||l(n,[/(?:近30日销量|30天销量|Last 30 days(?: sales| sold)?)\s*[:：]?\s*([\d,.]+)/i]),P=(w(t,/总销售额|Total Revenue|Total GMV/i)||"").match(/([\d,.]+)/)||l(n,[/(?:总销售额|Total Revenue|Total GMV)\s*[:：]?\s*(?:₱|PHP|P|¥|CNY)?\s*([\d,.]+)/i]),v=(w(t,/近30日销售额|30天销售额|Last 30 days revenue/i)||"").match(/([\d,.]+)/)||l(n,[/(?:近30日销售额|30天销售额|Last 30 days revenue)\s*[:：]?\s*(?:₱|PHP|P|¥|CNY)?\s*([\d,.]+)/i]),M=function(t){const e=[],n=Array.from(t.querySelectorAll("table"));for(const t of n){const n=t.querySelector("thead tr")||t.querySelector("tr");if(!n)continue;const r=Array.from(n.querySelectorAll("th, td")),o=r.map(t=>(t.innerText||"").trim()),s=o.join(" ");if(!/sku|规格|型号|款式|名称/i.test(s))continue;const a=r.map((t,e)=>{const n=(t.getAttribute("data-colkey")||"").trim();if(n){if("sku"===n)return"name";if("unitPrice"===n)return"price";if("salesRatePercent"===n)return"salesShare";if("stockNum"===n)return"stock";if("sales"===n)return"salesEstimate"}const r=o[e]||"",s=r.replace(/\s+/g,"");return s?/销量预估|预估|salesestimate|estimate/i.test(s)?"salesEstimate":/销量占比|占比|share|比例|percent|%/i.test(s)?"salesShare":/库存|stock/i.test(s)?"stock":/价格|售价|price/i.test(s)?"price":/^sku$/i.test(r.trim())||/sku/i.test(s)&&!/价格|售价|销量占比|占比|库存|销量预估|预估|share|percent|stock|price/i.test(s)?"name":null:null}),l=a.some(Boolean),c=Array.from(t.querySelectorAll("tbody tr"));for(const t of c){const n=Array.from(t.querySelectorAll("td"));if(!n.length)continue;const r={name:null,price:null,stock:null,salesShare:null,salesEstimate:null};n.forEach((t,e)=>{let n=a[e];if(n||l||(0===e&&(n="name"),1===e&&(n="price"),2===e&&(n="salesShare"),3===e&&(n="stock"),4===e&&(n="salesEstimate")),!n)return;const o=(t.textContent||t.innerText||"").trim();if(o)if("name"===n)r.name=o;else if("price"===n)r.price=i(o.replace(/[^\d.,]/g,""));else if("stock"===n)r.stock=i(o.replace(/[^\d.,]/g,""));else if("salesShare"===n){const t=o.match(/([\d.]+%)/);r.salesShare=t?t[1]:r.salesShare}else"salesEstimate"===n&&(r.salesEstimate=i(o.replace(/[^\d.,]/g,"")))}),(r.name||r.price||r.stock||r.salesShare||r.salesEstimate)&&e.push(r)}}return e}(t),q=M.length?[]:function(t){const e=[];for(const n of t){if(!/%/.test(n))continue;const t=n.match(/^(.+?)\s+(?:₱|PHP|P|¥|CNY)\s*([\d,.]+)\s+([\d.]+%)\s+([\d,.]+)\s+([\d,.]+)$/);t&&e.push({name:t[1].trim(),price:i(t[2]),salesShare:t[3],stock:i(t[4]),salesEstimate:i(t[5])})}return e}(r),C=M.length?M:q,D=C.map(t=>t?.price).filter(t=>"number"==typeof t);if(D.length){const t=Math.min(...D),e=Math.max(...D);x||(x=e>t?[t,e]:[t])}return u||e.push("未能从URL解析商品ID"),f||e.push("未找到卖家名称"),h||e.push("未找到类目信息"),g||e.push("未找到上架时间"),C.length||e.push("未找到SKU表格或SKU行"),{url:o,productId:u,sellerName:f,category:h,price:{currentPHPRange:S,currentCNYRange:x,originalRange:R,discount:A},listedDate:g,sales:{totalQty:k?i(k[1]):null,last30Qty:E?i(E[1]):null,totalRevenue:P?i(P[1]):null,last30Revenue:v?i(v[1]):null},sku:C,extractedAt:(new Date).toISOString(),warnings:e}}async function S(t=3e4){const e=Date.now();for(;Date.now()-e<t;){const t=a();if(t)return t;await r(500)}return null}function x(t){if(!t)return"";const e=t.price||{},n=t.sales||{},r=(t.sku||[]).map(t=>[t?.name??"",t?.price??"",t?.stock??"",t?.salesShare??"",t?.salesEstimate??""].join("|")).join(";;");return[t.productId??"",t.sellerName??"",t.category??"",t.listedDate??"",JSON.stringify(e.currentPHPRange??""),JSON.stringify(e.currentCNYRange??""),JSON.stringify(e.originalRange??""),e.discount??"",n.totalQty??"",n.last30Qty??"",n.totalRevenue??"",n.last30Revenue??"",r].join("::")}function R(t){if(!t)return!0;const e=t.trim();return!e||(!!/加载|loading/i.test(e)||!!/^(\.{2,}|-+|—+)$/.test(e))}function A(t){const e=Array.from(t.querySelectorAll("table"));for(const t of e){const e=t.querySelector("thead tr")||t.querySelector("tr");if(!e)continue;const n=Array.from(e.querySelectorAll("th, td")).map(t=>(t.innerText||"").trim()).join(" ");if(!/sku|规格|型号|款式|名称/i.test(n))continue;const r=Array.from(t.querySelectorAll("tbody tr"));let o=0,s=0;for(const t of r){const e=Array.from(t.querySelectorAll("td"));if(!e.length)continue;o+=1;e.every(t=>!R(t.textContent||""))&&(s+=1)}return{hasTable:!0,totalRows:o,completeRows:s,isComplete:o>0&&o===s}}return{hasTable:!1,totalRows:0,completeRows:0,isComplete:!1}}function k(t,e){return e?.hasTable?e.totalRows>0:Boolean(t&&t.sku&&t.sku.length)}async function E(t,{timeoutMs:e,pollMs:n,stableRounds:o,idleMs:s}){let a="",i=0,l=null;const c=Date.now();let u=Date.now();const f=new MutationObserver(()=>{u=Date.now()});f.observe(t,{subtree:!0,childList:!0,characterData:!0});try{for(;Date.now()-c<e;){const e=b(t),c=A(t),f=`${x(e)}::${c.totalRows}::${c.completeRows}`;f&&f===a?i+=1:(i=0,a=f),l=e;const h=Date.now()-u>=s,d=c.hasTable?c.isComplete:k(e,c);if(i>=o&&h&&d)return{data:e,stable:!0};await r(n)}}finally{f.disconnect()}return{data:l,stable:!1}}async function P(){await async function(){const t=m();if(!t.length)return;const e=u(1,3),n=t.slice();for(let t=0;t<e&&n.length;t+=1){const t=u(0,n.length-1),e=n.splice(t,1)[0];await d(e),await f(300,900)}}();let t=null;for(let e=1;e<=3&&(t=await S(5e3),!t);e+=1)e<3&&await r(300);if(!t)return{success:!1,error:"未检测到Shopdora模块，已重试3次。"};const e=function(){let t=!0;return(async()=>{for(;t;){const t=Math.max(0,document.body.scrollHeight-window.innerHeight);if(t>0){const e=u(160,520),n=Math.random()>.5?1:-1,r=Math.min(t,Math.max(0,window.scrollY+n*e));window.scrollTo({top:r,behavior:"smooth"})}await r(u(800,1600))}})(),()=>{t=!1}}();let n=null,o=!1;try{let e=1;for(;e<=3;e+=1){const s=await E(t,{timeoutMs:5e3,pollMs:800,stableRounds:3,idleMs:1200});if(n=s.data,o=s.stable,o)break;e<3&&await r(300)}}finally{e()}return!o&&n&&(n.warnings=n.warnings||[],n.warnings.push("字段仍在加载，已重试3次")),{success:!0,data:n}}const v="li.col-xs-2-4.shopee-search-item-result__item";function M(t){if(!t)return null;try{return new URL(t,location.origin).href}catch(t){return null}}function q(t){try{const e=new URL(t,location.origin);return e.searchParams.has("page")&&e.searchParams.set("page","0"),e.href}catch(t){return null}}function C(){const t=Array.from(document.querySelectorAll(v)),e=[];for(const n of t){const t=n.querySelector(".contents");if(!t)continue;let r=null;if("A"===t.tagName?r=t.getAttribute("href")||t.href:"function"==typeof t.getAttribute&&(r=t.getAttribute("href")),!r){const e=t.querySelector("a[href]");r=e?e.getAttribute("href")||e.href:null}const o=M(r);o&&e.push(o)}return e}function D(){return document.querySelectorAll(v).length}async function T(t=1600,e=16e3,n=400){const o=Date.now();let s=D(),a=0;for(;Date.now()-o<e;){await r(n);const e=D();if(e>0&&e===s){if(a+=n,a>=t)return!0}else s=e,a=0}return!1}async function H(t=3,e=700){const n=new Set;for(let o=0;o<t;o+=1){o>0&&await r(e);C().forEach(t=>n.add(t))}return Array.from(n)}async function N(){let e=0,n=0;const o=Date.now(),s=Math.max(320,Math.floor(.85*window.innerHeight));for(;Date.now()-o<t;){const t=Math.max(0,document.body.scrollHeight-window.innerHeight),o=Math.min(t,window.scrollY+s);window.scrollTo({top:o,behavior:"smooth"}),await r(1600);const a=D();a>n?(n=a,e=0):e+=1;const i=window.scrollY+window.innerHeight>=document.body.scrollHeight-2;if(e>=5&&i)break}await T(),await r(1300),window.scrollTo({top:0,behavior:"instant"}),await r(200)}function L(t){if(!t)return!0;if(t.disabled)return!0;return"true"===t.getAttribute("aria-disabled")||(!!t.classList.contains("disabled")||!!t.classList.contains("shopee-icon-button--disabled"))}function $(){const t=C();return t.length?t.slice(0,5).join("|"):""}function I(){try{return new URL(location.href).searchParams.get("page")}catch(t){return null}}async function Y(t,e,n=3e4,o=1e3){const s=Date.now();for(;Date.now()-s<n;){const n=$(),s=I();if(t&&n===t||null!=e&&s===e)return!0;await r(o)}return!1}async function j(t,r,o,s){if(!t&&null==r)return!1;history.back();return!!await Y(t,r,15e3)&&(await f(e,n),history.forward(),await Y(o,s,15e3),await f(e,n),!0)}async function U(e,n,o=1e3){const s=Date.now();for(;Date.now()-s<t;){const t=$(),s=I();if(t&&t!==e)return{signature:t,page:s,pageChanged:null!=n&&null!=s&&s!==n};if(null!=n&&null!=s&&s!==n)return{signature:t,page:s,pageChanged:!0};await r(o)}return null}async function B(t,e,{timeoutMs:n=3e4,forceChange:o=!1}={}){const s=Date.now();let a=0,i=0,l=o;for(;Date.now()-s<n;){const n=document.querySelectorAll(v).length,o=n?$():"";if(n===a&&n>0?i+=1:i=0,o&&o!==t&&(l=!0),null!=e&&n>0&&n!==e&&(l=!0),l&&i>=3)return{signature:o,count:n};a=n,await r(900)}return null}async function V(t,o,s){for(let a=1;a<=2;a+=1){t.scrollIntoView({block:"center"}),await f(500,2e3),t.click();const i=await U(o,s);if(i)return await f(e,n),i;a<2&&await r(1200)}return null}async function O(t=15e3){const e=Date.now();for(;Date.now()-e<t;){const t=document.querySelector(".shopee-icon-button.shopee-icon-button--right");if(t&&!L(t))return t;await r(500)}return null}async function Q({paginate:t=!1,maxPages:o=50}={}){const s=[],a=new Set;let i=0,l=0;const c=Number.isFinite(o)&&o>0?o:50;if(!await async function(t=3e4,e=1e3){const n=Date.now();for(;Date.now()-n<t;){const t=document.querySelectorAll(v);if(t.length)return Array.from(t);await r(e)}return null}())return{success:!1,error:"未找到商品列表，页面可能未加载完成。"};for(;;){i+=1,await f(e,n),await N(),await f(e,n);let o=[],u=0;for(let t=1;t<=3&&(u=D(),await T(),o=await H(),!(u>0&&o.length>=u));t+=1)t<3&&(await r(1800),await T());if(o.length?o.forEach(t=>a.add(t)):s.push(`第${i}页未解析到商品链接`),o.length)try{chrome.runtime.sendMessage({type:"collect-product-urls-progress",payload:{categoryUrl:q(location.href),page:i,urls:o}})}catch(t){}if(u>0&&o.length!==u&&s.push(`第${i}页数量校准: 列表${u}项，解析${o.length}条`),!t)break;if(i>=c){s.push(`已达到最大翻页数限制（${c}页）`);break}let h=!1;for(;;){const t=await O();if(!t){s.push("未找到可用下一页按钮");break}const e=$(),n=D(),o=I(),a=await V(t,e,o);if(a){const t=await B(e,n,{forceChange:a.pageChanged});if(t){if(i>0&&i-l>=2&&Math.random()<.18){await j(e,o,t.signature,a.page)&&(l=i)}h=!0;break}s.push("翻页后商品列表未稳定加载完成，继续重试")}else s.push("翻页后页面内容未更新，继续重试");await r(2400)}if(!h)break}const u={success:!0,urls:Array.from(a),pages:i,warnings:s};try{chrome.runtime.sendMessage({type:"collect-product-urls-progress",payload:{categoryUrl:q(location.href),page:i,urls:u.urls,done:!0,total:u.urls.length}})}catch(t){}return u}chrome.runtime.onMessage.addListener((t,e,n)=>{if(t){if("extract"===t.type)return P().then(n),!0;if("collect-product-urls"===t.type)return Q({paginate:Boolean(t.paginate),maxPages:t.maxPages}).then(n),!0;if("human-type"===t.type){const e=t.selector||"",r="string"==typeof t.text?t.text:"",o=e?document.querySelector(e):null;return o&&(o instanceof HTMLInputElement||o instanceof HTMLTextAreaElement)?(async function(t,e,{clear:n=!1}={}){if(!t)return;const r=t;r.focus(),n&&(r.value="",r.dispatchEvent(new Event("input",{bubbles:!0})));const o=Array.from(e||"");for(const t of o){const e="\n"===t?"Enter":t;r.dispatchEvent(new KeyboardEvent("keydown",{key:e,bubbles:!0})),r.value+=t,r.dispatchEvent(new Event("input",{bubbles:!0})),r.dispatchEvent(new KeyboardEvent("keyup",{key:e,bubbles:!0})),await f(100,300)}r.dispatchEvent(new Event("change",{bubbles:!0}))}(o,r,{clear:Boolean(t.clear)}).then(()=>n({success:!0})).catch(t=>n({success:!1,error:t?.message||"输入失败"})),!0):(n({success:!1,error:"未找到可输入元素"}),!1)}}})})();