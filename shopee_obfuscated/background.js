const BATCH_TIMEOUT_MS=45e3,FIXED_BATCH_CONCURRENCY=1,DAILY_ALARM_NAME="daily-crawl",DEFAULT_SCHEDULE_TIME="02:00",DEFAULT_CATEGORY_URL="",DEFAULT_CACHE_UPDATE_ENABLED=!0,MAX_DAILY_DAYS=120,INCOMPLETE_RETRY_LIMIT=2,BATCH_REST_EVERY=50,BATCH_REST_MIN_MS=3e5,BATCH_REST_MAX_MS=6e5,POST_RETRY_ROUNDS=5,POST_RETRY_DELAY_MS=12e4,CATEGORY_CACHE_TTL_HOURS=24,CATEGORY_CACHE_URL_KEY="cachedCategoryUrl",CATEGORY_CACHE_KEY="cachedCategoryUrls",CATEGORY_CACHE_UPDATED_AT_KEY="cachedCategoryUpdatedAt",SESSION_WINDOW_ID_KEY="sessionWindowId",KEEP_AUTO_TABS_OPEN=!0,CATEGORY_COLLECT_TIMEOUT_MS=18e5,MAX_DAILY_RUN_MS=828e5,VERIFY_COOLDOWN_MS=9e5,ITEM_GAP_MIN_MS=1200,ITEM_GAP_MAX_MS=3e3,PAGE_SWITCH_DELAY_MIN_MS=1e3,PAGE_SWITCH_DELAY_MAX_MS=3e3,SCHEDULE_MIN_HOUR=1,SCHEDULE_MAX_HOUR=23,SCHEDULE_WINDOW_MINUTES=60;let categoryTabId=null;const INCOMPLETE_WARNINGS=["未找到卖家名称","未找到类目信息","未找到上架时间","未找到SKU表格或SKU行","字段仍在加载"];let queue=[],results=[],running=!1,paused=!1,concurrency=1,pendingDailyRun=!1,verifyBlocked=!1,verifyBlockedUrl=null,verifyBlockedUntil=null,verifyBlockedPrevPaused=!1,sessionWindowId=null;function sleep(e){return new Promise(t=>setTimeout(t,e))}function storageGet(e){return new Promise(t=>{chrome.storage.local.get(e,e=>t(e||{}))})}function storageSet(e){return new Promise(t=>{chrome.storage.local.set(e,()=>t())})}function tabsQuery(e){return new Promise(t=>{chrome.tabs.query(e,e=>t(e||[]))})}async function loadSessionWindowId(){const e=(await storageGet(["sessionWindowId"])).sessionWindowId;sessionWindowId=Number.isFinite(e)?e:null}function setSessionWindowId(e){Number.isFinite(e)&&(sessionWindowId=e,storageSet({[SESSION_WINDOW_ID_KEY]:e}))}async function resolveSessionWindowId(){if(Number.isFinite(sessionWindowId))return sessionWindowId;const[e]=await tabsQuery({active:!0,lastFocusedWindow:!0});if(e&&!e.incognito)return setSessionWindowId(e.windowId),e.windowId;const t=(await tabsQuery({})).find(e=>e&&!e.incognito);return t?(setSessionWindowId(t.windowId),t.windowId):null}function isVerifyUrl(e){return!!e&&/\/verify\/(traffic|captcha|error)/i.test(e)}async function hydrateVerifyState(){const e=await storageGet(["verifyBlocked","verifyBlockedUrl","verifyBlockedUntil"]);verifyBlocked=Boolean(e.verifyBlocked),verifyBlockedUrl=e.verifyBlockedUrl||null,verifyBlockedUntil=e.verifyBlockedUntil?new Date(e.verifyBlockedUntil).getTime():null,verifyBlocked&&verifyBlockedUntil&&Date.now()>=verifyBlockedUntil&&await clearVerifyBlocked()}async function setVerifyBlocked(e){verifyBlocked||(verifyBlocked=!0,verifyBlockedUrl=e||null,verifyBlockedUntil=Date.now()+9e5,verifyBlockedPrevPaused=paused,paused=!0,saveBatchState(),await storageSet({verifyBlocked:!0,verifyBlockedUrl:verifyBlockedUrl,verifyBlockedUntil:new Date(verifyBlockedUntil).toISOString()}),chrome.runtime.sendMessage({type:"verify-blocked",url:verifyBlockedUrl,until:verifyBlockedUntil}))}async function clearVerifyBlocked(){verifyBlocked=!1,verifyBlockedUrl=null,verifyBlockedUntil=null,paused=verifyBlockedPrevPaused,verifyBlockedPrevPaused=!1,saveBatchState(),await storageSet({verifyBlocked:!1,verifyBlockedUrl:null,verifyBlockedUntil:null}),chrome.runtime.sendMessage({type:"verify-clear"})}async function waitForVerifyClear(){for(;verifyBlocked;){if(verifyBlockedUntil&&Date.now()>=verifyBlockedUntil){await clearVerifyBlocked();break}await sleep(1e3)}}function toYmd(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function parseScheduleTime(e){if(!e||!/^\d{2}:\d{2}$/.test(e))return{hours:2,minutes:0};const[t,r]=e.split(":");let a=Number.parseInt(t,10),n=Number.parseInt(r,10);return a=Number.isFinite(a)?a:2,n=Number.isFinite(n)?n:0,a<1&&(a=1,n=0),a>23&&(a=23,n=0),n=Math.min(59,Math.max(0,n)),23===a&&n>0&&(n=0),{hours:a,minutes:n}}function getScheduleWindow(e,t){const{hours:r,minutes:a}=parseScheduleTime(t),n=new Date(e);n.setHours(r,a,0,0);const i=new Date(n);i.setMinutes(i.getMinutes()-60);const s=new Date(n);s.setMinutes(s.getMinutes()+60);const o=new Date(e);o.setHours(1,0,0,0);const l=new Date(e);l.setHours(23,0,0,0);return{start:new Date(Math.max(i.getTime(),o.getTime())),end:new Date(Math.min(s.getTime(),l.getTime()))}}function randomTimeBetween(e,t){const r=e.getTime(),a=t.getTime();return r>=a?r:randomBetween(r,a)}function pickRandomRunTime(e,t=new Date){const r=getScheduleWindow(t,e),a=t.getTime(),n=r.end.getTime();if(a<=n){const e=Math.max(r.start.getTime(),a+1e3);if(e<=n)return randomTimeBetween(new Date(e),r.end)}const i=new Date(t);i.setDate(i.getDate()+1);const s=getScheduleWindow(i,e);return randomTimeBetween(s.start,s.end)}async function loadCategoryCache(e){const t=await storageGet([CATEGORY_CACHE_KEY,"cachedCategoryUpdatedAt","cachedCategoryUrl","listUrls"]),r=Array.isArray(t[CATEGORY_CACHE_KEY])?t[CATEGORY_CACHE_KEY]:[],a=t.cachedCategoryUrl||"",n=t.cachedCategoryUpdatedAt||null,i=Array.isArray(t.listUrls)?t.listUrls:[];if(!e||a!==e)return{urls:[],fallbackUrls:i,updatedAt:null,fresh:!1};if(!n)return{urls:r,updatedAt:null,fresh:!1};const s=new Date(n).getTime();return{urls:r,fallbackUrls:i,updatedAt:n,fresh:!!Number.isFinite(s)&&Date.now()-s<864e5}}async function saveCategoryCache(e,t){e&&await storageSet({[CATEGORY_CACHE_URL_KEY]:e,[CATEGORY_CACHE_KEY]:t,[CATEGORY_CACHE_UPDATED_AT_KEY]:(new Date).toISOString()})}function nextRunAt(e){return pickRandomRunTime(e,new Date)}async function loadConfig(){const e=await storageGet(["scheduleTime","categoryUrl","cacheUpdateEnabled","lastRunDate","lastRunAt","sessionWindowId"]),t=e.scheduleTime||"02:00",r=e.categoryUrl||"";concurrency=1;const a="boolean"!=typeof e.cacheUpdateEnabled||e.cacheUpdateEnabled;return{scheduleTime:t,categoryUrl:r,lastRunDate:e.lastRunDate||null,lastRunAt:e.lastRunAt||null,cacheUpdateEnabled:a,concurrency:concurrency,sessionWindowId:Number.isFinite(e.sessionWindowId)?e.sessionWindowId:null}}async function scheduleDailyAlarm(e){const t=nextRunAt(e||"02:00");chrome.alarms.create("daily-crawl",{when:t}),await storageSet({nextRunAt:new Date(t).toISOString()})}function shouldRunMissed(e,t){const r=new Date;if(t===toYmd(r))return!1;return r>=getScheduleWindow(r,e).end}function saveBatchState({saveResults:e=!0}={}){const t={batchQueue:queue,batchRunning:running,batchPaused:paused,batchConcurrency:concurrency};e&&(t.batchResults=results),chrome.storage.local.set(t)}function waitForTabComplete(e,t){return new Promise((r,a)=>{const n=setTimeout(()=>{chrome.tabs.onUpdated.removeListener(s),a(new Error("页面加载超时"))},45e3);function i(){clearTimeout(n),chrome.tabs.onUpdated.removeListener(s)}function s(t,a){t===e&&"complete"===a.status&&(i(),r())}chrome.tabs.onUpdated.addListener(s),chrome.tabs.get(e,e=>{chrome.runtime.lastError||function(e){return!(!e||"complete"!==e.status||t&&e.url!==t)}(e)&&(i(),r())})})}function sendMessageToTab(e,t,r=45e3){return new Promise((a,n)=>{const i=setTimeout(()=>{n(new Error("内容脚本响应超时"))},r);chrome.tabs.sendMessage(e,t,e=>{clearTimeout(i);const t=chrome.runtime.lastError;t?n(new Error(t.message)):a(e)})})}function randomBetween(e,t){const r=Math.min(e,t),a=Math.max(e,t);return Math.floor(r+Math.random()*(a-r+1))}function buildUrlPattern(e){try{const t=new URL(e);return`${t.origin}${t.pathname}*`}catch(e){return null}}function normalizeCategoryUrlForCache(e){try{const t=new URL(e);return t.searchParams.has("page")&&t.searchParams.set("page","0"),t.href}catch(t){return e||""}}async function updateCategoryCache(e,t){if(!e||!Array.isArray(t)||!t.length)return;const r=await storageGet([CATEGORY_CACHE_KEY]),a=Array.isArray(r[CATEGORY_CACHE_KEY])?r[CATEGORY_CACHE_KEY]:[],n=Array.from(new Set([...a,...t]));await saveCategoryCache(e,n)}async function ensureCategoryTab(e,t){if(categoryTabId)try{const t=await chrome.tabs.get(categoryTabId);if(t&&t.id&&!t.incognito)return await chrome.tabs.update(t.id,{url:e,active:!0}),t}catch(e){categoryTabId=null}const r=buildUrlPattern(e);if(r){const t=(await chrome.tabs.query({url:[r]})).find(e=>e&&e.id&&!e.incognito);if(t&&t.id)return categoryTabId=t.id,await chrome.tabs.update(t.id,{url:e,active:!0}),t}const a={url:e,active:!0};Number.isFinite(t)&&(a.windowId=t);const n=await chrome.tabs.create(a);return categoryTabId=n.id||null,n}function safeCloseTab(e){return new Promise(t=>{chrome.tabs.update(e,{url:"about:blank"},()=>t())})}function forceCloseTab(e){return e?new Promise(t=>{chrome.tabs.remove(e,()=>t())}):Promise.resolve()}async function restartWorkerTab(e){if(!e)return null;try{const t=await chrome.tabs.get(e);if(!t||t.incognito)return null;const r=await chrome.tabs.create({url:"about:blank",active:!1,windowId:t.windowId});return await forceCloseTab(e),r?.id??null}catch(e){return null}}function isIncompleteResult(e){if(!e||!e.success||!e.data)return!1;const t=e.data,r=(Array.isArray(t.warnings)?t.warnings:[]).some(e=>INCOMPLETE_WARNINGS.some(t=>e.includes(t))),a=!(t.sellerName&&t.category&&t.listedDate&&Array.isArray(t.sku)&&0!==t.sku.length);return r||a}function shouldRetryAfterRun(e){return!!(e&&e.success&&e.data)&&(!!e.data.productId&&isIncompleteResult(e))}async function extractFromUrl(e,t){let r=t;try{if(r){const t=await chrome.tabs.get(r);if(t?.incognito)return{result:{success:!1,error:"当前为无痕窗口，无法共享登录态"},tabId:r};await chrome.tabs.update(r,{url:e,active:!0})}else{const t=await resolveSessionWindowId(),a={url:e,active:!0};Number.isFinite(t)&&(a.windowId=t);const n=await chrome.tabs.create(a);if(r=n.id,n.incognito)return await safeCloseTab(r),{result:{success:!1,error:"当前为无痕窗口，无法共享登录态"},tabId:null}}await waitForTabComplete(r,e);const t=await chrome.tabs.get(r);if(t?.incognito)return{result:{success:!1,error:"当前为无痕窗口，无法共享登录态"},tabId:r};if(isVerifyUrl(t?.url))return await setVerifyBlocked(t.url),{result:{success:!1,error:"触发验证页",blocked:!0},tabId:r};await sleep(randomBetween(1e3,3e3));return{result:await sendMessageToTab(r,{type:"extract"},45e3)||{success:!1,error:"无响应"},tabId:r}}catch(e){return{result:{success:!1,error:e.message||"未知错误"},tabId:r}}}async function collectCategoryUrls(e,t=18e5){const r=await resolveSessionWindowId(),a=await ensureCategoryTab(e,r);try{if(a?.incognito)return{success:!1,error:"当前为无痕窗口，无法共享登录态"};await waitForTabComplete(a.id,e);const r=await chrome.tabs.get(a.id);if(r?.incognito)return{success:!1,error:"当前为无痕窗口，无法共享登录态"};if(isVerifyUrl(r?.url))return await setVerifyBlocked(r.url),{success:!1,error:"触发验证页",blocked:!0};await sleep(randomBetween(1e3,3e3));return await sendMessageToTab(a.id,{type:"collect-product-urls",paginate:!0,maxPages:50},t)||{success:!1,error:"无响应"}}catch(e){return{success:!1,error:e.message||"未知错误"}}}function buildDailyRecord(e,t){if(!e)return null;const r=e.extractedAt||(new Date).toISOString();return{...e,date:t,capturedAt:r}}function pruneSnapshots(e){if(!Array.isArray(e))return[];const t=e.slice().sort((e,t)=>(e.date||"").localeCompare(t.date||"")),r=new Date;r.setDate(r.getDate()-120);const a=toYmd(r);return t.filter(e=>(e.date||"")>=a)}async function saveDailySnapshots(e){if(!e.length)return;const t=await storageGet(["dailySnapshots"]),r=Array.isArray(t.dailySnapshots)?t.dailySnapshots:[],a=new Map;for(const e of r)e&&e.date&&e.url&&a.set(`${e.date}::${e.url}`,e);for(const t of e)t&&t.date&&t.url&&a.set(`${t.date}::${t.url}`,t);const n=pruneSnapshots(Array.from(a.values()));await storageSet({dailySnapshots:n})}async function processQueue({emitEvents:e=!0,recordResults:t=!0,allowPause:r=!0,onItem:a,deadlineMs:n}={}){if(running)return;running=!0,await hydrateVerifyState(),await loadSessionWindowId(),t&&(results=[]),saveBatchState({saveResults:t});const i=()=>Number.isFinite(n)&&Date.now()>=n;let s=!1,o=queue.length,l=0;const c=Math.max(1,Math.min(concurrency,o||1)),u=new Map,d=new Map;let y=0;async function f(){if(i())return void(s=!0);const n=Array.from({length:c},()=>async function(){let n=null;try{for(;;){if(verifyBlocked&&(await waitForVerifyClear(),verifyBlocked))continue;if(i()){s=!0;break}if(0===queue.length)break;if(r&&paused){await sleep(300);continue}const c=queue.shift();if(!c)continue;const{result:f,tabId:w}=await extractFromUrl(c,n);if(n=w,f?.blocked){queue.unshift(c);continue}l+=1,y+=1;const m={url:c,index:l,total:o,result:f};if(t&&(d.set(c,m),results=Array.from(d.values()),saveBatchState({saveResults:!0})),e&&chrome.runtime.sendMessage({type:"batch-progress",payload:m}),"function"==typeof a&&a(m),isIncompleteResult(f)){const e=u.get(c)||0;e<2&&(u.set(c,e+1),queue.push(c))}if(y%50!=0){const e=randomBetween(1200,3e3);if(i()){s=!0;break}await sleep(e)}if(y%50==0){if(i()){s=!0;break}null!=n&&(n=await restartWorkerTab(n)),await sleep(randomBetween(3e5,6e5))}}}finally{null!=n&&await safeCloseTab(n)}}());await Promise.all(n)}await f();for(let e=1;e<=5;e+=1){if(i()){s=!0;break}const e=Array.from(d.values()).filter(e=>shouldRetryAfterRun(e?.result)).map(e=>e.url).filter(Boolean);if(!e.length)break;if(queue=Array.from(new Set(e)),o+=queue.length,i()){s=!0;break}if(await sleep(12e4),await f(),s)break}e&&chrome.runtime.sendMessage({type:"batch-complete",results:results}),running=!1,saveBatchState({saveResults:t}),pendingDailyRun&&(pendingDailyRun=!1,runDailyJob("pending"))}async function runDailyJob(e){if(running)return void(pendingDailyRun=!0);await loadSessionWindowId();const t=await loadConfig();if(!t.categoryUrl)return;const r=Date.now()+828e5,a=await loadCategoryCache(t.categoryUrl),n="manual"===e,i=!1!==t.cacheUpdateEnabled;let s=a.urls.slice(),o=null;if(!s.length&&a.fallbackUrls&&a.fallbackUrls.length&&(s=a.fallbackUrls.slice(),await saveCategoryCache(t.categoryUrl,s)),i&&(n||!a.fresh||!s.length)){const e=Math.max(0,r-Date.now());if(e<=0)return void await scheduleDailyAlarm(t.scheduleTime);const a=Math.min(18e5,e);if(o=await collectCategoryUrls(t.categoryUrl,a),o?.success&&Array.isArray(o.urls)&&o.urls.length){const e=new Set([...s,...o.urls]);s=Array.from(e),await saveCategoryCache(t.categoryUrl,s)}}if(!s.length){s=(await loadCategoryCache(t.categoryUrl)).urls.slice()}if(!s.length)return void await scheduleDailyAlarm(t.scheduleTime);queue=s.slice(),paused=!1,concurrency=1;const l=toYmd(new Date),c=new Map;let u=Promise.resolve();await processQueue({emitEvents:"manual"===e,recordResults:!0,allowPause:!1,deadlineMs:r,onItem:e=>{if(e?.result?.success&&e.result.data){const t=buildDailyRecord(e.result.data,l);t&&(c.set(t.url,t),u=u.then(()=>saveDailySnapshots([t])))}}}),await u,await saveDailySnapshots(Array.from(c.values()));const d=new Date;await storageSet({lastRunDate:toYmd(d),lastRunAt:d.toISOString()}),await scheduleDailyAlarm(t.scheduleTime),pendingDailyRun&&(pendingDailyRun=!1,await runDailyJob("pending"))}async function initSchedule(e){const t=await loadConfig();await storageSet({scheduleTime:t.scheduleTime,categoryUrl:t.categoryUrl}),await scheduleDailyAlarm(t.scheduleTime),"startup"===e&&shouldRunMissed(t.scheduleTime,t.lastRunDate)&&await runDailyJob("startup")}chrome.runtime.onInstalled.addListener(()=>{initSchedule("install")}),chrome.runtime.onStartup.addListener(()=>{initSchedule("startup")}),chrome.alarms.onAlarm.addListener(e=>{e&&"daily-crawl"===e.name&&runDailyJob("alarm")}),chrome.runtime.onMessage.addListener((e,t,r)=>{if(e){if("batch-start"===e.type)return e.incognito?void r({started:!1,error:"当前为无痕窗口，无法共享登录态"}):(Number.isFinite(e.windowId)&&setSessionWindowId(e.windowId),queue=(e.urls||[]).filter(Boolean),queue.length?(concurrency=1,paused=!1,saveBatchState({saveResults:!0}),processQueue({emitEvents:!0,recordResults:!0,allowPause:!0}),r({started:!0}),!0):void r({started:!1,error:"URL列表为空"}));if("collect-product-urls-progress"===e.type){const t=e.payload||{};return updateCategoryCache(normalizeCategoryUrlForCache(t.categoryUrl||""),Array.isArray(t.urls)?t.urls:[]).then(()=>{r({ok:!0})}),!0}if("batch-pause"===e.type)return paused=!0,saveBatchState(),r({paused:!0}),!0;if("batch-resume"===e.type)return paused=!1,saveBatchState(),r({paused:!1}),!0;if("batch-status"===e.type)return r({running:running,paused:paused,remaining:queue.length,concurrency:concurrency}),!0;if("batch-get-results"===e.type)return r({results:results}),!0;if("config-update"===e.type){const t=e.scheduleTime||"02:00",a=(e.categoryUrl||"").trim(),n="boolean"!=typeof e.cacheUpdateEnabled||e.cacheUpdateEnabled;return!e.incognito&&Number.isFinite(e.windowId)&&setSessionWindowId(e.windowId),storageSet({scheduleTime:t,categoryUrl:a,cacheUpdateEnabled:n}).then(async()=>{await scheduleDailyAlarm(t),r({ok:!0})}),!0}return"config-status"===e.type?(loadConfig().then(e=>{storageGet(["nextRunAt","verifyBlocked","verifyBlockedUrl","verifyBlockedUntil"]).then(t=>{r({scheduleTime:e.scheduleTime,categoryUrl:e.categoryUrl,lastRunAt:e.lastRunAt,lastRunDate:e.lastRunDate,nextRunAt:t.nextRunAt||null,running:running,cacheUpdateEnabled:e.cacheUpdateEnabled,verifyBlocked:Boolean(t.verifyBlocked),verifyBlockedUrl:t.verifyBlockedUrl||null,verifyBlockedUntil:t.verifyBlockedUntil||null})})}),!0):"verify-resume"===e.type?(clearVerifyBlocked().then(()=>{r({ok:!0})}),!0):"daily-run-now"===e.type?(!e.incognito&&Number.isFinite(e.windowId)&&setSessionWindowId(e.windowId),runDailyJob("manual"),r({started:!0}),!0):"session-bind"===e.type?(!e.incognito&&Number.isFinite(e.windowId)&&setSessionWindowId(e.windowId),r({ok:!0}),!0):void 0}});